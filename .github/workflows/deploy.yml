name: AKS Deployment

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
  workflow_dispatch:

env:
  AZ_RG_PRI: cloudops-practice-primary-rg
  AKS_NAME_PRI: cloudops-practice-primary-aks
  AZ_RG_SECOND: cloudops-practice-secondary-rg
  AKS_NAME_SECOND: cloudops-practice-secondary-aks
  ACR_SERVER: ${{ secrets.ACR_LOGIN_SERVER }} 
  IMAGE_TAG: ${{ github.event.workflow_run.head_sha || github.sha }}
  NAMESPACE: roadmap-maker

jobs:
  filter:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      migrations: ${{ steps.filter.outputs.migrations }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'infra/helm/backend/**'
            frontend:
              - 'frontend/**'
              - 'infra/helm/frontend/**'
            migrations:
              - 'backend/prisma/migrations/**'

  migrate-db:
    needs: filter
    if: needs.filter.outputs.migrations == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies & Run Migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }} 
        run: |
          cd backend
          npm install prisma
          npx prisma migrate deploy

  deploy-frontend:
    needs: filter
    if: needs.filter.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - uses: azure/setup-kubectl@v3
      - uses: azure/setup-helm@v3
      
      - name: Deploy frontend to Primary
        run: |
          az aks get-credentials --resource-group $AZ_RG_PRI --name $AKS_NAME_PRI --overwrite-existing
          helm upgrade --install frontend ./infra/helm/frontend \
            --namespace $NAMESPACE --create-namespace \
            --set image.repository=${{ env.ACR_SERVER }}/frontend \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set replicaCount=2

      - name: Deploy frontend to Secondary
        run: |
          az aks get-credentials --resource-group $AZ_RG_SECOND --name $AKS_NAME_SECOND --overwrite-existing
          helm upgrade --install frontend ./infra/helm/frontend \
            --namespace $NAMESPACE --create-namespace \
            --set image.repository=${{ env.ACR_SERVER }}/frontend \
            --set image.tag=${{ env.IMAGE_TAG }}

  deploy-backend:
    needs: [filter, migrate-db]
    if: needs.filter.outputs.backend == 'true' && (needs.migrate-db.result == 'success' || needs.migrate-db.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - uses: azure/setup-kubectl@v3
      - uses: azure/setup-helm@v3

      - name: Deploy backend to Primary
        run: |
          az aks get-credentials --resource-group $AZ_RG_PRI --name $AKS_NAME_PRI --overwrite-existing
          helm upgrade --install backend ./infra/helm/backend \
            --namespace $NAMESPACE --create-namespace \
            --set image.repository=${{ env.ACR_SERVER }}/backend \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set replicaCount=2 \
            --set autoscaling.enabled=true \
            --set autoscaling.minReplicas=2 \
            --set autoscaling.maxReplicas=20 \
            --set autoscaling.targetCPUUtilizationPercentage=50 \
            --set env.DATABASE_URL="${{ secrets.DATABASE_URL }}"

      - name: Deploy backend to Secondary
        run: |
          az aks get-credentials --resource-group $AZ_RG_SECOND --name $AKS_NAME_SECOND --overwrite-existing
          helm upgrade --install backend ./infra/helm/backend \
            --namespace $NAMESPACE --create-namespace \
            --set image.repository=${{ env.ACR_SERVER }}/backend \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set env.DATABASE_URL="${{ secrets.DATABASE_URL }}"