name: "Infrastructure (Terraform)"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'infra/terraform/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'infra/terraform/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  TF_WORKING_DIR: 'infra/terraform'
  ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
  ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
  ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
  ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
  TF_VAR_db_admin_password: ${{ secrets.DB_PASSWORD }}

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - 'infra/terraform/**'

  terraform:
    name: Terraform Plan & Apply
    needs: filter
    if: needs.filter.outputs.infra == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        if: github.event_name == 'pull_request'
        continue-on-error: true 
        run: |
          terraform plan -no-color -input=false > tfplan.txt
          echo "PLAN_EXIT_CODE=$?" >> $GITHUB_ENV

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let plan = '';
            try {
              plan = fs.readFileSync('${{ env.TF_WORKING_DIR }}/tfplan.txt', 'utf8');
            } catch (err) {
              plan = 'Error reading plan file.';
            }

            if (plan.length > 60000) {
              plan = plan.substring(0, 60000) + '... (Output too long, check Actions log)';
            }

            const output = `#### Terraform Plan
            Status: \`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan Output</summary>

            \`\`\`hcl
            ${plan}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}*`;

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            const comments = await github.rest.issues.listComments({
              owner, repo, issue_number
            });

            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Terraform Plan')
            );

            if (botComment) {
              await github.rest.issues.deleteComment({
                owner, repo, comment_id: botComment.id
              });
            }

            await github.rest.issues.createComment({
              owner, repo, issue_number, body: output
            });

      - name: Check Plan Status
        if: github.event_name == 'pull_request' && env.PLAN_EXIT_CODE != '0'
        run: exit 1

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false